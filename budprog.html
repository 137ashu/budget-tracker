<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="Content-Security-Policy" content="script-src 'self' https://www.gstatic.com https://*.firebaseio.com https://cdn.jsdelivr.net;">
  <title>Monthly Budget Tracker</title>
  
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* CSS remains identical to the previous version */
    body { font-family: "Segoe UI", sans-serif; background-color: #f2f8f5; margin: 0; padding: 0; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; }
    .container { width: 92%; max-width: 640px; margin: 40px auto; background: white; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); overflow: hidden; }
    .header { background-color: #157F4C; color: white; padding: 12px 18px; text-align: center; font-size: 1.4rem; font-weight: 700; display: flex; justify-content: space-between; align-items: center; }
    #userInfo { font-size: 0.9rem; text-align: left; }
    .header .title { flex-grow: 1; text-align: center; }
    #authButton { background-color: #f2f8f5; color: #076442; font-weight: 700; padding: 6px 10px; font-size: 0.9rem; }
    .settings-btn { background: none; border: none; font-size: 1.5rem; color: white; cursor: pointer; padding: 0 10px; }
    .cycle-nav { background-color: #116a40; color: #e0f2f1; text-align: center; padding: 6px; font-size: 0.9rem; font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
    .cycle-nav button { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; font-weight: bold; padding: 0 15px; }
    #categories { padding: 12px 12px 6px 12px; }
    .category { background-color: #EAF8F1; border: 1px solid #36C591; border-radius: 10px; margin: 12px; padding: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
    .category-top { display:flex; justify-content: space-between; align-items: center; gap: 8px; margin-bottom: 8px; }
    .cat-left { font-weight: 700; color:#0f5e3e; }
    .cat-right { display: flex; align-items: center; gap: 8px; font-weight:700; color:#0f5e3e; font-size:0.95rem; }
    .cat-right .negative { color:#b91c1c; }
    .progress { background-color: #e9efe9; border-radius: 10px; height: 24px; margin-bottom: 10px; overflow: hidden; position: relative; }
    .progress-bar { background-color: #67D5AD; height: 100%; width: 100%; display:flex; align-items:center; justify-content:center; color: #064a36; font-weight: 700; transition: width 0.35s ease; font-size: 0.9rem; }
    .controls { display: flex; flex-direction: column; gap: 8px; }
    .controls-bottom { display: flex; gap: 8px; align-items: center; }
    input[type="text"], input[type="number"], input[type="date"] { padding: 8px 10px; border-radius: 6px; border: 1px solid #cfdccc; font-size: 0.95rem; box-sizing: border-box; font-family: "Segoe UI", sans-serif; }
    .controls-bottom input[type="number"] { width: 100px; }
    .controls-bottom input[type="date"] { flex: 1; }
    .controls-bottom .btn { flex-shrink: 0; }
    .btn { background-color: #076442; color:white; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; font-weight:600; font-family: "Segoe UI", sans-serif; }
    .icon-btn { background-color: #076442; color: white; border: none; border-radius: 6px; padding: 4px 8px; font-size: 1rem; cursor: pointer; line-height: 1; }
    .add-block { padding: 12px; margin: 0 12px 12px 12px; display:flex; gap:8px; align-items:center; justify-content:center; }
    .summary { background-color: #157F4C; color: white; padding: 14px; text-align: center; border-radius: 0 0 12px 12px; font-size: 1rem; display: flex; flex-direction: column; align-items: center; gap: 8px; }
    #historicalSummary { padding: 12px; }
    #historicalSummary h3 { color: #0f5e3e; text-align: center; margin-top: 10px; margin-bottom: 15px; }
    .hist-month-bar { margin-bottom: 12px; }
    .hist-month-bar .label { font-weight: 600; font-size: 0.9rem; color: #333; margin-bottom: 4px; }
    .multi-progress-bar { display: flex; height: 22px; background-color: #e9efe9; border-radius: 8px; overflow: hidden; width: 100%; }
    .multi-progress-bar-segment { height: 100%; transition: width 0.3s ease; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
    .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 10px; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 15px; }
    .close-btn { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
    #appLoader { text-align: center; padding: 40px; font-size: 1.2rem; color: #0f5e3e; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div id="userInfo"></div>
      <div class="title">üí∞ Budget Tracker</div>
      <button id="authButton" class="btn">Sign In</button>
    </div>

    <div id="appContent" style="display: none;">
      <div class="cycle-nav">
        <button data-action="prev-cycle" title="Previous Month">‚Äπ</button>
        <span id="cycleDisplay"></span>
        <button data-action="next-cycle" title="Next Month">‚Ä∫</button>
      </div>

      <div id="categories" aria-live="polite"></div>

      <div class="add-block">
        <input id="newName" type="text" placeholder="New category name" />
        <input id="newBudget" type="number" placeholder="Budget amount" />
        <button class="btn" data-action="add-category">Add Category</button>
      </div>

      <div class="summary" id="summary">
        <div id="totalBudget">Total Budget: ‚Çπ0</div>
        <div id="totalSpent">Total Spent (this cycle): ‚Çπ0</div>
        <div id="totalRemaining">Remaining (this cycle): ‚Çπ0</div>
        <div class="chart-container"><canvas id="expensePieChart"></canvas></div>
        <div class="export-buttons"><button class="btn" data-action="export-csv">Export All Data (CSV)</button></div>
      </div>
      
      <div id="historicalSummary"></div>
    </div>
    <div id="appLoader">Loading...</div>
  </div>

  <div id="historyModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle"></h3>
        <span class="close-btn" data-action="close-modal">&times;</span>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>

<script>
// --- FIREBASE SETUP ---
const firebaseConfig = {
  apiKey: "AIzaSyCnbm3WlbPU2KiL5jVZatTQg1PMMGW-lNo",
  authDomain: "my-budget-tracker-b22b2.firebaseapp.com",
  projectId: "my-budget-tracker-b22b2",
  storageBucket: "my-budget-tracker-b22b2.firebasestorage.app",
  messagingSenderId: "411372843389",
  appId: "1:411372843389:web:78c5b98f1d4b7910dcdc14",
  measurementId: "G-WDG0G61K4X"
};

// Use the compat libraries for the v8 syntax we are familiar with
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
let currentUser;
let categories = [];
let budgetSettings = { cycleStartDay: 1 };
let viewingDate = new Date();
let expensePieChart;
// --- END FIREBASE SETUP ---

const CHART_COLORS = ['#4CAF50','#2196F3','#FFC107','#E91E63','#9C27B0','#FF9800','#00BCD4','#8BC34A','#607D8B','#FF5722'];

// --- AUTHENTICATION ---
function signInWithGoogle() {
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider).catch(error => console.error("Sign in error", error));
}
function signOutUser() { auth.signOut(); }

auth.onAuthStateChanged(async user => {
  const appContent = document.getElementById('appContent');
  const appLoader = document.getElementById('appLoader');
  const authButton = document.getElementById('authButton');
  const userInfoDiv = document.getElementById('userInfo');

  if (user) {
    currentUser = user;
    appLoader.textContent = `Loading data for ${user.displayName.split(' ')[0]}...`;
    
    const settingsDoc = await db.collection('users').doc(currentUser.uid).get();
    if (settingsDoc.exists && settingsDoc.data().settings) {
        budgetSettings = settingsDoc.data().settings;
    } else {
        db.collection('users').doc(currentUser.uid).set({ settings: budgetSettings });
    }

    userInfoDiv.textContent = `Hi, ${user.displayName.split(' ')[0]}`;
    authButton.textContent = 'Sign Out';
    
    appContent.style.display = 'block';
    appLoader.style.display = 'none';
    render();
  } else {
    currentUser = null;
    appContent.style.display = 'none';
    appLoader.style.display = 'block';
    appLoader.textContent = 'Please sign in to manage your budget.';
    userInfoDiv.textContent = '';
    authButton.textContent = 'Sign In with Google';
  }
});

// --- DATA & RENDERING LOGIC ---
async function render() {
  // ... The render function is IDENTICAL to the previous version, but we add data attributes to the buttons
  if (!currentUser) return;
  const { cycleStartDate, cycleEndDate } = getCycleDates(viewingDate);
  document.getElementById('cycleDisplay').textContent = 
    `${cycleStartDate.toLocaleDateString('en-GB')} - ${cycleEndDate.toLocaleDateString('en-GB')}`;

  const categoriesSnapshot = await db.collection('users').doc(currentUser.uid).collection('categories').get();
  categories = categoriesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

  const container = document.getElementById("categories");
  container.innerHTML = "";
  let totalBudget = 0, totalSpentInCycle = 0;

  categories.forEach(cat => {
    const expensesInCycle = cat.expenses.filter(exp => new Date(exp.date) >= cycleStartDate && new Date(exp.date) <= cycleEndDate);
    const spentInCycle = expensesInCycle.reduce((acc, curr) => acc + curr.amount, 0);
    const bud = Math.round(cat.budget);
    const remainingInCycle = bud - spentInCycle;
    totalBudget += bud; totalSpentInCycle += spentInCycle;
    let percentRemaining = Math.max(0, Math.min(100, isFinite((remainingInCycle / bud) * 100) ? (remainingInCycle / bud) * 100 : 0));
    const item = document.createElement("div"); item.className = "category";
    // NOTE: ADDING data-* attributes to all buttons for event handling
    item.innerHTML = `
      <div class="category-top">
        <div class="cat-left">${escapeHtml(cat.name)}</div>
        <div class="cat-right">
          <span><span class="${remainingInCycle < 0 ? 'negative' : ''}">${Math.round(remainingInCycle)}</span> / ${bud}</span>
          <button class="icon-btn" data-action="show-history" data-id="${cat.id}" title="View Full History">üï∞Ô∏è</button>
          <button class="icon-btn" data-action="manage-category" data-id="${cat.id}" title="Manage Category">‚úèÔ∏è</button>
        </div>
      </div>
      <div class="progress"><div class="progress-bar" style="width: ${percentRemaining}%;">${Math.floor(percentRemaining)}%</div></div>
      <div class="controls">
        <input type="text" id="desc-${cat.id}" placeholder="Expense description" />
        <div class="controls-bottom">
            <input type="number" id="expense-${cat.id}" placeholder="Amount" min="0" />
            <input type="date" id="date-${cat.id}" value="${new Date().toISOString().slice(0, 10)}"/>
            <button class="btn" data-action="add-expense" data-id="${cat.id}">Add</button>
        </div>
      </div>`;
    container.appendChild(item);
  });
  // ... rest of render function remains the same ...
  document.getElementById("totalBudget").textContent = `Total Budget: ‚Çπ${totalBudget}`;
  document.getElementById("totalSpent").textContent = `Total Spent (this cycle): ‚Çπ${Math.round(totalSpentInCycle)}`;
  document.getElementById("totalRemaining").textContent = `Remaining (this cycle): ‚Çπ${Math.round(totalBudget - totalSpentInCycle)}`;
  updatePieChart(cycleStartDate, cycleEndDate);
  renderHistoricalSummary();
}

// --- EVENT HANDLING (The New Way) ---
document.addEventListener('DOMContentLoaded', () => {
  const authButton = document.getElementById('authButton');
  authButton.addEventListener('click', () => {
    if (currentUser) {
      signOutUser();
    } else {
      signInWithGoogle();
    }
  });

  // Event delegation for all other buttons
  document.body.addEventListener('click', (event) => {
    const target = event.target;
    const action = target.dataset.action;
    if (!action) return;

    const categoryId = target.dataset.id;
    const expenseId = target.dataset.expenseId;

    switch (action) {
      case 'add-category': addCategory(); break;
      case 'add-expense': addExpense(categoryId); break;
      case 'manage-category': manageCategory(categoryId); break;
      case 'show-history': showHistory(categoryId); break;
      case 'edit-expense': editExpense(categoryId, expenseId); break;
      case 'delete-expense': deleteExpense(categoryId, expenseId); break;
      case 'prev-cycle': navigateCycle(-1); break;
      case 'next-cycle': navigateCycle(1); break;
      case 'export-csv': exportCSV(); break;
      case 'close-modal': closeModal(); break;
    }
  });
});

// --- CORE FUNCTIONS (Unchanged, but now called by the event handler) ---
async function addCategory() {
  if (!currentUser) return;
  const name = document.getElementById("newName").value.trim();
  const budget = parseFloat(document.getElementById("newBudget").value);
  if (!name || !isFinite(budget) || budget <= 0) return alert("Enter valid name and budget");
  await db.collection('users').doc(currentUser.uid).collection('categories').add({ name, budget: Math.round(budget), expenses: [] });
  document.getElementById("newName").value = ""; document.getElementById("newBudget").value = "";
  render();
}
// ... The rest of the functions (addExpense, manageCategory, etc.) are the same as before ...
// We just need to modify showHistory and edit/delete to pass the expenseId correctly.

async function showHistory(categoryId) {
  const modal = document.getElementById('historyModal');
  const cat = categories.find(c => c.id === categoryId);
  if (!cat) return;
  document.getElementById('modalTitle').textContent = `Full History for: ${escapeHtml(cat.name)}`;
  const modalBody = document.getElementById('modalBody');
  modalBody.innerHTML = '';
  if (cat.expenses.length === 0) { modalBody.innerHTML = '<p>No expenses recorded yet.</p>'; } else {
    [...cat.expenses].sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(exp => {
      const itemDiv = document.createElement('div'); itemDiv.className = 'history-item';
      itemDiv.innerHTML = `<div class="history-details"><span class="desc">‚Çπ${exp.amount} - ${escapeHtml(exp.description)}</span><span class="date">${exp.date}</span></div><div class="history-actions"><button class="btn" data-action="edit-expense" data-id="${categoryId}" data-expense-id="${exp.id}">Edit</button><button class="btn" data-action="delete-expense" data-id="${categoryId}" data-expense-id="${exp.id}">Delete</button></div>`;
      modalBody.appendChild(itemDiv);
    });
  }
  modal.style.display = 'block';
}

async function deleteExpense(categoryId, expenseId) {
  expenseId = Number(expenseId); // Convert string from dataset to number
  if (!confirm("Delete this expense?")) return;
  const catRef = db.collection('users').doc(currentUser.uid).collection('categories').doc(categoryId);
  const doc = await catRef.get();
  const updatedExpenses = doc.data().expenses.filter(exp => exp.id !== expenseId);
  await catRef.update({ expenses: updatedExpenses });
  render();
  // Find the category in the local array and update it to refresh the modal correctly
  const cat = categories.find(c => c.id === categoryId);
  if (cat) cat.expenses = updatedExpenses;
  showHistory(categoryId);
}

async function editExpense(categoryId, expenseId) {
    expenseId = Number(expenseId); // Convert string from dataset to number
    const catRef = db.collection('users').doc(currentUser.uid).collection('categories').doc(categoryId);
    const doc = await catRef.get();
    let expenses = doc.data().expenses;
    const expIndex = expenses.findIndex(e => e.id === expenseId);
    if (expIndex === -1) return;
    const exp = expenses[expIndex];
    
    const newDate = prompt("Date:", exp.date); if (newDate === null) return;
    const newDesc = prompt("Description:", exp.description); if (newDesc === null) return;
    const newAmount = parseFloat(prompt("Amount:", exp.amount)); if (!isFinite(newAmount) || newAmount <= 0) return alert("Invalid amount.");

    expenses[expIndex] = { ...exp, amount: newAmount, description: newDesc.trim(), date: newDate };
    await catRef.update({ expenses });
    render();
    // Update local cache and refresh modal
    const cat = categories.find(c => c.id === categoryId);
    if (cat) cat.expenses = expenses;
    showHistory(categoryId);
}

// All other utility functions (closeModal, escapeHtml, getCycleDates, updatePieChart, etc.) remain unchanged.
async function manageCategory(categoryId) {
  if (!currentUser) return;
  const catRef = db.collection('users').doc(currentUser.uid).collection('categories').doc(categoryId);
  const doc = await catRef.get();
  const cat = doc.data();
  const action = prompt(`Type 'edit' or 'delete' for "${cat.name}".`, "edit");
  if (!action) return;
  if (action.toLowerCase() === 'delete') {
    if (confirm(`Delete "${cat.name}"?`)) { await catRef.delete(); render(); }
  } else if (action.toLowerCase() === 'edit') {
    const newName = prompt("Rename category:", cat.name); if (newName === null) return;
    const newBudget = parseInt(prompt("Set new budget:", String(Math.round(cat.budget))), 10);
    if (!isFinite(newBudget) || newBudget < 0) return alert("Enter a valid budget.");
    await catRef.update({ name: newName.trim() || cat.name, budget: Math.round(newBudget) });
    render();
  }
}
function closeModal() { document.getElementById('historyModal').style.display = 'none'; }
window.onclick = function(event) { if (event.target == document.getElementById('historyModal')) { closeModal(); } }
function escapeHtml(s) { return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }
function getCycleDates(dateForCycle) {
    const startDay = budgetSettings.cycleStartDay;
    let cycleStartDate = new Date(dateForCycle.getFullYear(), dateForCycle.getMonth(), startDay);
    if (dateForCycle.getDate() < startDay) { cycleStartDate.setMonth(cycleStartDate.getMonth() - 1); }
    let cycleEndDate = new Date(cycleStartDate.getFullYear(), cycleStartDate.getMonth() + 1, startDay - 1);
    cycleEndDate.setHours(23, 59, 59, 999);
    return { cycleStartDate, cycleEndDate };
}
function navigateCycle(direction) { viewingDate.setMonth(viewingDate.getMonth() + direction); render(); }
function updatePieChart(cycleStartDate, cycleEndDate) {
    const chartData = { labels: [], data: [], colors: [] };
    categories.forEach((cat, index) => {
        const spentInCycle = cat.expenses.filter(exp => new Date(exp.date) >= cycleStartDate && new Date(exp.date) <= cycleEndDate).reduce((acc, curr) => acc + curr.amount, 0);
        if (spentInCycle > 0) { chartData.labels.push(cat.name); chartData.data.push(spentInCycle); chartData.colors.push(CHART_COLORS[index % CHART_COLORS.length]); }
    });
    const ctx = document.getElementById('expensePieChart').getContext('2d');
    if (expensePieChart) {
        expensePieChart.data.labels = chartData.labels; expensePieChart.data.datasets[0].data = chartData.data; expensePieChart.data.datasets[0].backgroundColor = chartData.colors; expensePieChart.update();
    } else {
        expensePieChart = new Chart(ctx, { type: 'pie', data: { labels: chartData.labels, datasets: [{ data: chartData.data, backgroundColor: chartData.colors, hoverOffset: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, title: { display: true, text: 'Expenses This Cycle', color: 'white', font: { size: 16 } } } } });
    }
}
function renderHistoricalSummary() {
    const container = document.getElementById('historicalSummary');
    container.innerHTML = '<h3>Last 6 Months\' Spending</h3>';
    const totalBudget = categories.reduce((acc, cat) => acc + cat.budget, 0);
    if (totalBudget === 0) return;
    for (let i = 0; i < 6; i++) {
        const monthDate = new Date(); monthDate.setMonth(monthDate.getMonth() - i);
        const { cycleStartDate, cycleEndDate } = getCycleDates(monthDate);
        const monthDiv = document.createElement('div'); monthDiv.className = 'hist-month-bar';
        const label = document.createElement('div'); label.className = 'label';
        label.textContent = `${cycleStartDate.toLocaleDateString('en-GB')} - ${cycleEndDate.toLocaleDateString('en-GB')}`;
        const progressBar = document.createElement('div'); progressBar.className = 'multi-progress-bar';
        let totalSpentInMonth = 0;
        categories.forEach((cat, catIndex) => {
            const spentInMonth = cat.expenses.filter(exp => new Date(exp.date) >= cycleStartDate && new Date(exp.date) <= cycleEndDate).reduce((acc, curr) => acc + curr.amount, 0);
            totalSpentInMonth += spentInMonth;
            if (spentInMonth > 0) {
                const segment = document.createElement('div'); segment.className = 'multi-progress-bar-segment';
                segment.style.width = `${(spentInMonth / totalBudget) * 100}%`;
                segment.style.backgroundColor = CHART_COLORS[catIndex % CHART_COLORS.length];
                segment.title = `${cat.name}: ‚Çπ${Math.round(spentInMonth)}`;
                progressBar.appendChild(segment);
            }
        });
        if (totalSpentInMonth > 0) { monthDiv.appendChild(label); monthDiv.appendChild(progressBar); container.appendChild(monthDiv); }
    }
}
function exportCSV() {
    let csvContent = "Category,Date,Description,Amount\n";
    categories.forEach(cat => { cat.expenses.forEach(exp => { csvContent += [cat.name, exp.date, `"${exp.description.replace(/"/g, '""')}"`, exp.amount].join(",") + "\n"; }); });
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement("a");
    link.href = URL.createObjectURL(blob); link.download = `budget_export_${new Date().toISOString().slice(0, 10)}.csv`;
    document.body.appendChild(link); link.click(); document.body.removeChild(link);
}
</script>
</body>
</html>